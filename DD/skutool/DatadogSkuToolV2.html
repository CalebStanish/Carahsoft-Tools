<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Datadogs Qt Tool 2.1</title>
  <!-- Match your working SheetJS version -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      background-color: #f4f4f4;
      padding-top: 60px;
    }
    .container {
      width: 90%;
      max-width: 900px;
      background: white;
      padding: 2.5rem;
      border-radius: 1.5rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      text-align: left;
      box-sizing: border-box;
    }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .row-full { display: grid; grid-template-columns: 1fr; gap: 1rem; }
    select, input[type="text"], button {
      padding: 0.75rem;
      font-size: 1rem;
      border-radius: 0.5rem;
      border: 1px solid #ccc;
      background-color: #fff;
    }
    button {
      background-color: #007bff;
      color: white; cursor: pointer; border: none;
    }
    button:hover { background-color: #0056b3; }
    .status { margin-top: .5rem; color: #666; font-size: .9rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 2rem; }
    th, td { border: 1px solid #ccc; padding: .75rem; text-align: left; word-break: break-word; }
    th { background-color: #f0f0f0; }
    .muted { color: #888; }
    .actions { display: flex; gap: .5rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Datadogs Qt Tool 2.1</h1>
    <div class="row">
      <div>
        <label for="mode">Select Price List</label>
        <select id="mode">
          <option value="price-annual">Price Annual</option>
          <option value="gov-annual">Government Price Annual</option>
        </select>
      </div>
      <div>
        <label for="query">Search term</label>
        <input id="query" type="text" placeholder="Enter product name / secondary term" />
      </div>
    </div>
    <div class="row-full" style="margin-top:1rem;">
      <div class="actions">
        <button id="submit-btn">Search</button>
        <button id="clear-btn" style="background:#6c757d;">Clear</button>
      </div>
      <div class="status" id="status">Loading workbook…</div>
    </div>

    <table id="results-table" style="display:none;">
      <thead>
        <tr>
          <th>Carahsoft SKU (A)</th>
          <th>Price (D)</th>
          <th>Annual Price (E)</th>
          <th>Matched In</th>
          <th>Row</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // ===== Config =====
    const FILE_NAME = "DatadogPricelist2.1.xlsx"; // same folder as this HTML
    const SHEET_NAME_ANNUAL_CANDIDATES = ["annual", "price annual"];
    const SHEET_NAME_GOV_CANDIDATES = ["government price annual", "government price", "gov price annual"];

    // Column indices (0-based)
    const COL = { A:0, B:1, C:2, D:3, E:4, F:5, G:6, H:7, I:8, J:9 };

    let workbook = null;

    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");
    const table = $("results-table");
    const tbody = table.querySelector("tbody");

    function setStatus(text){ statusEl.textContent = text; }

    async function loadWorkbook() {
      try {
        // Use encoded path first (safer on GitHub Pages), fallback to raw
        let buf;
        try {
          const r1 = await fetch(encodeURIComponent(FILE_NAME), { cache: "no-store" });
          if (!r1.ok) throw new Error(`HTTP ${r1.status}`);
          buf = await r1.arrayBuffer();
        } catch (e1) {
          const r2 = await fetch(FILE_NAME, { cache: "no-store" });
          if (!r2.ok) throw new Error(`HTTP ${r2.status}`);
          buf = await r2.arrayBuffer();
        }
        // Match your working pattern: read from Uint8Array
        workbook = XLSX.read(new Uint8Array(buf), { type: "array" });
        setStatus(`Workbook loaded • Sheets: ${workbook.SheetNames.length}`);
      } catch (err) {
        console.error(err);
        setStatus("Failed to load workbook — check filename and path.");
      }
    }

    function norm(s){ return (s||"").toString().trim().toLowerCase(); }

    function pickSheetName(mode){
      if (!workbook) return null;
      const names = workbook.SheetNames;
      const lower = names.map(n => norm(n));

      if (mode === "price-annual") {
        for (const cand of SHEET_NAME_ANNUAL_CANDIDATES) {
          const idx = lower.indexOf(cand);
          if (idx !== -1) return names[idx];
        }
        return names[1] || names[0]; // page 2 fallback
      } else {
        for (const cand of SHEET_NAME_GOV_CANDIDATES) {
          const idx = lower.indexOf(cand);
          if (idx !== -1) return names[idx];
        }
        return names[5] || names[names.length - 1]; // page 6 fallback
      }
    }

    function sheetToMatrix(sheet){
      return XLSX.utils.sheet_to_json(sheet, { header: 1, raw: true, defval: "" });
    }

    function searchRows(matrix, primaryColIdx, secondaryColIdx, term){
      const results = [];
      const q = norm(term);
      if (!q) return results;

      // Primary search
      for (let r = 0; r < matrix.length; r++){
        const row = matrix[r];
        const v = norm(row[primaryColIdx]);
        if (v && v.includes(q)){
          results.push({ rowIndex: r, row, matchedIn: "Primary" });
        }
      }
      if (results.length) return results;

      // Secondary search
      for (let r = 0; r < matrix.length; r++){
        const row = matrix[r];
        const v = norm(row[secondaryColIdx]);
        if (v && v.includes(q)){
          results.push({ rowIndex: r, row, matchedIn: "Secondary" });
        }
      }
      return results;
    }

    function renderResults(rows){
      tbody.innerHTML = "";
      if (!rows || !rows.length){
        table.style.display = "table";
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 6;
        td.innerHTML = '<span class="muted">Not Available</span>';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      rows.forEach(({ rowIndex, row, matchedIn }) => {
        const sku = row[COL.A] ?? "";
        const price = row[COL.D] ?? "";
        const annual = row[COL.E] ?? "";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${sku}</td>
          <td>${price}</td>
          <td>${annual}</td>
          <td>${matchedIn}</td>
          <td>${rowIndex + 1}</td>
          <td></td>
        `;

        const actionsCell = tr.lastElementChild;
        const copyBtn = document.createElement("button");
        copyBtn.textContent = "Copy Row";
        copyBtn.addEventListener("click", async () => {
          const text = [sku, price, annual].join("\t");
          try {
            await navigator.clipboard.writeText(text);
            alert("Row copied to clipboard!");
          } catch {
            // Fallback
            const ta = document.createElement("textarea");
            ta.value = text; document.body.appendChild(ta);
            ta.select(); document.execCommand("copy");
            document.body.removeChild(ta);
            alert("Row copied (fallback).");
          }
        });
        actionsCell.appendChild(copyBtn);

        tbody.appendChild(tr);
      });

      table.style.display = "table";
    }

    $("submit-btn").addEventListener("click", () => {
      if (!workbook) { alert("Workbook not loaded yet."); return; }

      const mode = $("mode").value;
      const term = $("query").value;

      const sheetName = pickSheetName(mode);
      if (!sheetName) { alert("Could not select a sheet for this mode."); return; }

      const sheet = workbook.Sheets[sheetName];
      const matrix = sheetToMatrix(sheet);

      // Column logic per mode
      const primary = (mode === "price-annual") ? COL.B : COL.C;
      const secondary = COL.J;

      const matches = searchRows(matrix, primary, secondary, term);
      renderResults(matches);
      setStatus(`Mode: ${mode === "price-annual" ? "Price Annual" : "Government Price Annual"} • Sheet: ${sheetName} • Matches: ${matches.length}`);
    });

    $("clear-btn").addEventListener("click", () => {
      $("query").value = "";
      tbody.innerHTML = "";
      table.style.display = "none";
    });

    // Boot
    document.addEventListener("DOMContentLoaded", loadWorkbook);
  </script>
</body>
</html>
