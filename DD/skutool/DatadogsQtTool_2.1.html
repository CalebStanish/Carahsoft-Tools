<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Datadog SKU Lookup — Exact Match (Multi-line)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background:#0b1220; color:#eef2f7; display:flex; min-height:100vh; }
    .card { margin:auto; width:min(1100px, 94vw); background:#111a2b; padding:28px; border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.35);}
    h1 { margin:0 0 8px; font-size:1.4rem; }
    .muted { color:#9bb0c5; margin:0 0 18px; }
    .row { display:flex; gap:12px; margin: 12px 0 18px; align-items:center; flex-wrap:wrap; }
    textarea { width:100%; min-height:160px; padding:12px 14px; border-radius:12px; border:1px solid #2a3b5d; background:#0d1626; color:#eef2f7; resize:vertical; }
    select { padding:10px 12px; border-radius:10px; border:1px solid #2a3b5d; background:#0d1626; color:#eef2f7; }
    button { padding:8px 14px; border:0; border-radius:8px; background:#3a86ff; color:white; font-weight:600; cursor:pointer; font-size:0.85rem; }
    button.small-btn { padding:6px 10px; font-size:0.75rem; background:#5f9fff; margin-top:4px; }
    button:disabled{opacity:.5; cursor:not-allowed;}
    .status { font-size:.95rem; color:#9bb0c5; margin:6px 0 12px; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { text-align:left; padding:10px 12px; border-bottom:1px solid #223251; }
    th { color:#9bb0c5; font-weight:600; vertical-align:bottom; }
    .small { font-size:.9rem; color:#9bb0c5; margin-top:10px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#1a2742; color:#cfe0ff; font-size:.8rem; margin-left:6px;}
    .notfound { margin-top:14px; padding:12px; background:#1a243e; border-radius:10px; }
    code { background:#0d1626; padding:2px 6px; border-radius:6px; }
    label { color:#9bb0c5; font-size:0.95rem; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Datadog Price Lookup <span class="pill">Exact Match</span></h1>
    <p class="muted">
      Paste a column of product names from Excel (one per line). Choose a search mode below.<br/>
      <b>Price – Annual:</b> Sheet #2, search Column <b>B</b>, then <b>J</b>. &nbsp;|&nbsp;
      <b>Government Price – Annual:</b> Sheet “Government Price - Annual” (Sheet #6), search Column <b>C</b>, then <b>J</b>.
    </p>

    <div class="row">
      <label for="mode">Search mode:</label>
      <select id="mode">
        <option value="commercial">Price – Annual (Sheet #2, B → J)</option>
        <option value="government">Government Price – Annual (Sheet #6, C → J)</option>
      </select>
      <div id="sheetStatus" class="status"></div>
    </div>

    <textarea id="names" placeholder="Paste product names here — one per line"></textarea>
    <div class="row">
      <button id="searchBtn" disabled>Search</button>
      <div id="status" class="status">Loading workbook…</div>
    </div>

    <div id="results"></div>
    <div id="notfound"></div>

    <div class="small">
      Place this file next to <code>DatadogPricelist2.1.xlsx</code> and serve via a local server (e.g., VS Code Live Server).
    </div>
  </div>

  <script>
    const EXCEL_FILE = 'DatadogPricelist2.1.xlsx';

    // Parsed data per sheet/mode
    let rowsCommercial = []; // sheet #2: A,B,D,E,J
    let rowsGovernment = []; // sheet "Government Price - Annual" (or #6): A,C,D,E,J

    // For copy buttons
    let lastResults = [];

    const fmtUSD = n => {
      if (n === null || n === undefined || n === '') return '';
      const num = typeof n === 'number' ? n :
        Number(String(n).replace(/[^0-9.-]/g, ''));
      if (Number.isFinite(num)) {
        return num.toLocaleString(undefined, { style: 'currency', currency: 'USD', maximumFractionDigits: 2 });
      }
      return n;
    };

    function normalize(s) {
      return String(s ?? '')
        .trim()
        .replace(/\s+/g, ' ')
        .toLowerCase();
    }

    function parseSheet(ws, which) {
      // which = 'commercial' or 'government'
      const out = [];
      const ref = ws['!ref'];
      if (!ref) return out;
      const range = XLSX.utils.decode_range(ref);

      for (let r = range.s.r + 1; r <= range.e.r; r++) { // skip header
        const cell = (c) => ws[XLSX.utils.encode_cell({ r, c })]?.v ?? '';
        const A = cell(0); // SKU
        const B = cell(1); // Commercial name
        const C = cell(2); // Government name
        const D = cell(3); // Price
        const E = cell(4); // Annual Price
        const J = cell(9); // Alt name
        if (A === '' && B === '' && C === '' && D === '' && E === '' && J === '') continue;

        out.push({
          sku: String(A).trim(),
          nameB: String(B).trim(),
          nameC: String(C).trim(),
          priceD: D,
          priceE: E,
          nameJ: String(J).trim()
        });
      }
      return out;
    }

    (async function loadWorkbook() {
      try {
        const res = await fetch(EXCEL_FILE);
        if (!res.ok) throw new Error(`HTTP ${res.status} loading ${EXCEL_FILE}`);
        const ab = await res.arrayBuffer();
        const wb = XLSX.read(ab, { type: 'array' });

        // Sheet #2 (index 1) for commercial
        const sheetName2 = wb.SheetNames[1];
        const ws2 = wb.Sheets[sheetName2];
        if (!ws2) throw new Error('Sheet #2 not found');
        rowsCommercial = parseSheet(ws2, 'commercial');

        // Government: try by name first, else fallback to index 5
        const govByName = wb.Sheets['Government Price - Annual'];
        const wsGov = govByName || wb.Sheets[wb.SheetNames[5]];
        if (!wsGov) {
          document.getElementById('sheetStatus').textContent =
            'Government sheet not found (expected "Government Price - Annual" or sheet #6). Commercial mode will still work.';
        } else {
          rowsGovernment = parseSheet(wsGov, 'government');
          document.getElementById('sheetStatus').textContent =
            `Loaded: Commercial rows ${rowsCommercial.length} • Government rows ${rowsGovernment.length}`;
        }

        document.getElementById('status').textContent = 'Workbook loaded.';
        document.getElementById('searchBtn').disabled = false;
      } catch (err) {
        document.getElementById('status').textContent = `Failed to load workbook: ${err.message}`;
        console.error(err);
      }
    })();

    // Exact match for one name by mode:
    // - commercial: B → J
    // - government: C → J
    function exactMatchOne(name, mode) {
      const q = normalize(name);
      if (!q) return null;

      const rows = mode === 'government' ? rowsGovernment : rowsCommercial;

      if (mode === 'government') {
        const mC = rows.find(r => normalize(r.nameC) === q);
        if (mC) return { ...mC, matchedName: mC.nameC || mC.nameJ };
        const mJ = rows.find(r => normalize(r.nameJ) === q);
        if (mJ) return { ...mJ, matchedName: mJ.nameC || mJ.nameJ };
        return null;
      } else {
        const mB = rows.find(r => normalize(r.nameB) === q);
        if (mB) return { ...mB, matchedName: mB.nameB || mB.nameJ };
        const mJ = rows.find(r => normalize(r.nameJ) === q);
        if (mJ) return { ...mJ, matchedName: mJ.nameB || mJ.nameJ };
        return null;
      }
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    function copyColumn(field) {
      if (!lastResults.length) return;
      const text = lastResults.map(r => r[field]).join('\n');
      navigator.clipboard.writeText(text).then(() => {
        alert(`${field.toUpperCase()} column copied to clipboard!`);
      });
    }

    function renderBatch(inputText) {
      const resultsWrap = document.getElementById('results');
      const notFoundWrap = document.getElementById('notfound');
      const mode = document.getElementById('mode').value;

      const lines = inputText
        .split(/\r?\n/)
        .map(l => String(l).split(/\t/)[0]) // if whole rows pasted, take first cell per line
        .map(l => l.trim())
        .filter(l => l.length > 0);

      const rowsOut = [];
      const misses = [];

      for (const name of lines) {
        const hit = exactMatchOne(name, mode);
        if (hit) {
          rowsOut.push({
            input: name,
            matched: hit.matchedName,
            sku: hit.sku,
            price: hit.priceD,
            annual: fmtUSD(hit.priceE)
          });
        } else {
          misses.push(name);
        }
      }

      lastResults = rowsOut;

      if (rowsOut.length) {
        resultsWrap.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Input Name</th>
                <th>Matched Name</th>
                <th>
                  SKU (A)<br>
                  <button class="small-btn" onclick="copyColumn('sku')">Copy SKU</button>
                </th>
                <th>Price (D)</th>
                <th>
                  Annual Price (E)<br>
                  <button class="small-btn" onclick="copyColumn('annual')">Copy Annual</button>
                </th>
              </tr>
            </thead>
            <tbody>
              ${rowsOut.map(r => `
                <tr>
                  <td>${escapeHtml(r.input)}</td>
                  <td>${escapeHtml(r.matched)}</td>
                  <td>${escapeHtml(r.sku)}</td>
                  <td>${fmtUSD(r.price)}</td>
                  <td>${escapeHtml(r.annual)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>`;
      } else {
        resultsWrap.innerHTML = `<p>No matches found.</p>`;
      }

      if (misses.length) {
        notFoundWrap.innerHTML = `
          <div class="notfound">
            <strong>Not found (${misses.length}):</strong><br>
            ${misses.map(m => `<code>${escapeHtml(m)}</code>`).join(' ')}
          </div>`;
      } else {
        notFoundWrap.innerHTML = '';
      }
    }

    const btn = document.getElementById('searchBtn');
    const ta = document.getElementById('names');
    btn.addEventListener('click', () => renderBatch(ta.value));
    ta.addEventListener('keydown', e => {
      if ((e.metaKey || e.ctrlKey) && e.key.toLowerCase() === 'enter' && !btn.disabled) {
        e.preventDefault();
        renderBatch(ta.value);
      }
    });

    window.copyColumn = copyColumn; // expose to HTML
  </script>
</body>
</html>
